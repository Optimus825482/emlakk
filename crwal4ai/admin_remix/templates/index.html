{% extends "base.html" %} {% block title %}Panel{% endblock %} {% block breadcrumb %}Yüksek Performanslı Analitik{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>
  .tech-card {
    @apply bg-[#0D0D0D] border border-white/5 relative overflow-hidden;
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
  }
  .tech-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 2px;
    height: 100%;
    @apply bg-brand-accent opacity-50;
  }
  .stat-label {
    @apply text-[10px] font-black uppercase tracking-[0.2em] text-slate-500;
  }
  .stat-value {
    @apply text-3xl font-display font-bold text-white tracking-tighter;
  }
  .glow-text {
    text-shadow: 0 0 15px rgba(217, 255, 0, 0.3);
  }
  .tech-grid {
    background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.02) 1px, transparent 0);
    background-size: 24px 24px;
  }
</style>
{% endblock %}

{% block content %}
<div
  x-data="dashboard()"
  x-init="init()"
  x-cloak
  class="space-y-8 tech-grid pb-20"
>
  <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6">
    <div>
      <div class="flex items-center gap-2 mb-2">
        <span class="w-2 h-2 bg-brand-accent animate-pulse"></span>
        <span class="text-[10px] font-black text-brand-accent uppercase tracking-[0.3em]">Sistem İzleme</span>
      </div>
      <h1 class="text-4xl lg:text-5xl font-extrabold text-white font-display tracking-tighter leading-none">
        PAZAR<br/><span class="text-slate-500">DİNAMİKLERİ</span>
      </h1>
    </div>

    <div class="flex flex-wrap items-center gap-4 bg-white/5 p-2 border border-white/5">
      <div class="flex items-center gap-2 px-3 border-r border-white/10">
        <i data-lucide="map-pin" class="w-4 h-4 text-brand-accent"></i>
        <select
          x-model="districtFilter"
          @change="loadAllData()"
          class="bg-transparent text-xs font-bold text-slate-300 focus:outline-none cursor-pointer py-2 uppercase tracking-widest"
        >
          <option value="all">Genel (Tüm İlçeler)</option>
          {% for district in districts %}
          <option value="{{ district.value }}">{{ district.label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex items-center gap-2 px-3">
        <i data-lucide="clock" class="w-4 h-4 text-slate-500"></i>
        <select
          x-model="timeFilter"
          @change="loadAllData()"
          class="bg-transparent text-xs font-bold text-slate-300 focus:outline-none cursor-pointer py-2 uppercase tracking-widest"
        >
          <option value="7">7 Günlük Analiz</option>
          <option value="14">14 Günlük Analiz</option>
          <option value="30">30 Günlük Analiz</option>
          <option value="90">Çeyrek Görünüm</option>
        </select>
      </div>

      <button
        @click="loadAllData()"
        class="p-2.5 bg-brand-accent text-brand-black hover:bg-white transition-colors"
        :class="$store.app.globalLoading ? 'animate-spin' : ''"
      >
        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="tech-card p-6 group transition-all hover:bg-white/[0.02]">
      <div class="flex justify-between items-start mb-8">
        <span class="stat-label">Toplam Portföy</span>
        <div class="w-8 h-8 flex items-center justify-center border border-white/10 text-slate-500 group-hover:text-brand-accent transition-colors">
          <i data-lucide="database" class="w-4 h-4"></i>
        </div>
      </div>
      <div class="stat-value glow-text" x-text="stats.total_listings?.toLocaleString()">0</div>
      <div class="flex items-center gap-2 mt-2">
        <span class="text-[10px] font-bold text-emerald-500 bg-emerald-500/10 px-1.5 py-0.5">+1.2%</span>
        <span class="text-[10px] text-slate-600 font-bold uppercase tracking-wider">önceki döneme göre</span>
      </div>
    </div>

    <div class="tech-card p-6 group transition-all hover:bg-white/[0.02]">
      <div class="flex justify-between items-start mb-8">
        <span class="stat-label">7 Günlük Giriş</span>
        <div class="w-8 h-8 flex items-center justify-center border border-white/10 text-slate-500 group-hover:text-emerald-500 transition-colors">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
        </div>
      </div>
      <div class="stat-value text-emerald-500" x-text="stats.new_listings?.toLocaleString()">0</div>
      <div class="flex items-center gap-2 mt-2">
        <div class="flex -space-x-1">
          <template x-for="i in 5">
            <div class="w-1.5 h-3 bg-emerald-500/20" :class="i <= 3 ? 'bg-emerald-500' : ''"></div>
          </template>
        </div>
        <span class="text-[10px] text-slate-600 font-bold uppercase tracking-wider">Yüksek Hız</span>
      </div>
    </div>

    <div class="tech-card p-6 group transition-all hover:bg-white/[0.02]">
      <div class="flex justify-between items-start mb-8">
        <span class="stat-label">7 Günlük Çıkış</span>
        <div class="w-8 h-8 flex items-center justify-center border border-white/10 text-slate-500 group-hover:text-rose-500 transition-colors">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </div>
      </div>
      <div class="stat-value text-rose-500" x-text="stats.removed_listings?.toLocaleString()">0</div>
      <div class="flex items-center gap-2 mt-2">
        <span class="text-[10px] text-slate-600 font-bold uppercase tracking-wider">Satışlar ve Süre Sonu</span>
      </div>
    </div>

    <div class="tech-card p-6 bg-brand-accent/[0.03] border-brand-accent/20">
      <div class="flex justify-between items-start mb-8">
        <span class="stat-label text-brand-accent">Motor Durumu</span>
        <div class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-accent opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-brand-accent"></span>
        </div>
      </div>
      <div class="text-xl font-display font-bold text-white uppercase tracking-tight" x-text="stats.last_job?.status || 'BOŞTA'">BEKLEMEDE</div>
      <div class="mt-4 flex flex-col gap-1">
        <div class="flex justify-between text-[8px] font-black text-slate-500 uppercase">
          <span>Son Senkronizasyon</span>
          <span class="text-slate-300" x-text="stats.last_job?.created_at || 'Hiçbir zaman'">--:--</span>
        </div>
        <div class="w-full h-1 bg-white/5 mt-1 overflow-hidden">
           <div class="h-full bg-brand-accent" :style="`width: ${stats.last_job?.status === 'running' ? '65%' : '100%'}`"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" x-show="stats.categories">
    <template x-for="(cat_stats, cat_name) in stats.categories" :key="cat_name">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 contents">
        <template x-if="cat_stats.satilik > 0 || cat_stats.new_satilik > 0">
          <div class="tech-card p-5 group hover:bg-white/[0.02] transition-all">
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 flex items-center justify-center bg-brand-accent/10 border border-brand-accent/20 rounded-lg">
                  <i :data-lucide="cat_name === 'konut' ? 'home' : (cat_name === 'arsa' ? 'map' : 'building')" class="w-4 h-4 text-brand-accent"></i>
                </div>
                <div>
                  <h4 class="text-xs font-black text-white uppercase tracking-wider" x-text="cat_name.toUpperCase() + ' SATILIK'"></h4>
                  <div class="flex items-center gap-1.5 mt-0.5">
                    <i data-lucide="clock" class="w-2.5 h-2.5 text-slate-600"></i>
                    <span class="text-[8px] font-bold text-slate-500 uppercase" x-text="cat_stats.last_updated_satilik || 'GÜNCELLEME YOK'"></span>
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div class="stat-value text-2xl" x-text="cat_stats.satilik.toLocaleString()">0</div>
                <div x-show="cat_stats.new_satilik > 0" class="text-[9px] font-black text-emerald-500 mt-1">
                  +<span x-text="cat_stats.new_satilik"></span> YENİ
                </div>
              </div>
            </div>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
              <div class="h-full bg-brand-accent/30" :style="`width: ${Math.min((cat_stats.satilik / stats.total_listings) * 100 * 2, 100)}%`"></div>
            </div>
          </div>
        </template>

        <template x-if="cat_stats.kiralik > 0 || cat_stats.new_kiralik > 0">
          <div class="tech-card p-5 group hover:bg-white/[0.02] transition-all">
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 flex items-center justify-center bg-blue-500/10 border border-blue-500/20 rounded-lg">
                  <i :data-lucide="cat_name === 'konut' ? 'key' : 'building-2'" class="w-4 h-4 text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-xs font-black text-white uppercase tracking-wider" x-text="cat_name.toUpperCase() + ' KİRALIK'"></h4>
                  <div class="flex items-center gap-1.5 mt-0.5">
                    <i data-lucide="clock" class="w-2.5 h-2.5 text-slate-600"></i>
                    <span class="text-[8px] font-bold text-slate-500 uppercase" x-text="cat_stats.last_updated_kiralik || 'GÜNCELLEME YOK'"></span>
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div class="stat-value text-2xl text-blue-400" x-text="cat_stats.kiralik.toLocaleString()">0</div>
                <div x-show="cat_stats.new_kiralik > 0" class="text-[9px] font-black text-blue-500 mt-1">
                  +<span x-text="cat_stats.new_kiralik"></span> YENİ
                </div>
              </div>
            </div>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500/30" :style="`width: ${Math.min((cat_stats.kiralik / stats.total_listings) * 100 * 2, 100)}%`"></div>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>
      <div class="flex items-center justify-between mb-8">
        <div>
          <h3 class="text-sm font-black uppercase tracking-widest text-white mb-1">Fiyat Oynaklık Endeksi</h3>
          <p class="text-[10px] text-slate-500 font-bold uppercase">Tüm kategorilerdeki ortalama fiyat dalgalanmaları</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 bg-brand-accent"></span>
            <span class="text-[8px] font-black text-slate-400 uppercase">Ort. Fiyat</span>
          </div>
        </div>
      </div>
      <div id="priceTrendsChart" class="h-80 w-full"></div>
    </div>

    <div class="tech-card p-8">
      <div class="mb-8">
        <h3 class="text-sm font-black uppercase tracking-widest text-white mb-1">Mahalle Dağılımı</h3>
        <p class="text-[10px] text-slate-500 font-bold uppercase">Konuma göre portföy yoğunluğu</p>
      </div>
      <div id="neighborhoodTreemap" class="h-80 w-full"></div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <div class="lg:col-span-3 tech-card p-8">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h3 class="text-sm font-black uppercase tracking-widest text-white mb-1">Kategori Yoğunluk Matrisi</h3>
          <p class="text-[10px] text-slate-500 font-bold uppercase">İlan durumuna göre portföy türü dağılımı</p>
        </div>
      </div>
      <div id="categoryHeatmap" class="h-64 w-full"></div>
    </div>

    <div class="flex flex-col gap-4">
      <a href="/listings" class="flex-1 tech-card group p-6 flex flex-col justify-between hover:bg-brand-accent transition-all duration-300">
        <div class="stat-label group-hover:text-brand-black transition-colors">Gezgin</div>
        <div class="flex items-end justify-between">
          <span class="text-xl font-bold text-white group-hover:text-brand-black transition-colors">Arşiv</span>
          <i data-lucide="arrow-right" class="w-6 h-6 text-slate-700 group-hover:text-brand-black"></i>
        </div>
      </a>
      <a href="/crawler" class="flex-1 tech-card group p-6 flex flex-col justify-between hover:bg-white transition-all duration-300">
        <div class="stat-label group-hover:text-brand-black transition-colors">Operasyonel</div>
        <div class="flex items-end justify-between">
          <span class="text-xl font-bold text-white group-hover:text-brand-black transition-colors">Terminal</span>
          <i data-lucide="cpu" class="w-6 h-6 text-slate-700 group-hover:text-brand-black"></i>
        </div>
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function dashboard() {
    return {
      timeFilter: "7",
      districtFilter: "all",
      stats: {},
      priceTrends: [],
      neighborhoods: [],
      
      charts: {
        price: null,
        treemap: null,
        heatmap: null
      },

      async init() {
        await this.loadAllData();
      },

      async loadAllData() {
        this.$store.app.setLoading(true);
        try {
          const [dashboardRes, trendsRes, neighborsRes] = await Promise.all([
            fetch(`/api/dashboard?days=${this.timeFilter}&district=${this.districtFilter}`),
            fetch(`/api/stats/price-trends?days=${this.timeFilter}&district=${this.districtFilter}`),
            fetch(`/api/stats/neighborhoods?district=${this.districtFilter}`)
          ]);

          const [dData, tData, nData] = await Promise.all([
            dashboardRes.json(),
            trendsRes.json(),
            neighborsRes.json()
          ]);

          if (dData.success) this.stats = dData.data;
          if (tData.success) this.priceTrends = tData.data;
          if (nData.success) this.neighborhoods = nData.data;

          this.renderCharts();
          
          this.$store.app.toast("İstihbarat Verileri Senkronize Edildi", "success");
        } catch (error) {
          console.error("Panel Senkronizasyonu Başarısız:", error);
          this.$store.app.toast("Veri Senkronizasyon Hatası", "error");
        } finally {
          this.$store.app.setLoading(false);
          lucide.createIcons();
        }
      },

      renderCharts() {
        this.renderPriceTrends();
        this.renderNeighborhoodTreemap();
        this.renderCategoryHeatmap();
      },

      renderPriceTrends() {
        const options = {
          series: [{
            name: 'Ort. Fiyat',
            data: this.priceTrends.map(item => item.avg_price)
          }],
          chart: {
            height: 320,
            type: 'area',
            toolbar: { show: false },
            animations: { enabled: true, easing: 'easeinout', speed: 800 },
            background: 'transparent'
          },
          colors: ['#d9ff00'],
          dataLabels: { enabled: false },
          stroke: { curve: 'smooth', width: 2 },
          fill: {
            type: 'gradient',
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.4,
              opacityTo: 0,
              stops: [0, 100]
            }
          },
          grid: {
            borderColor: 'rgba(255,255,255,0.05)',
            strokeDashArray: 4,
            xaxis: { lines: { show: true } }
          },
          xaxis: {
            categories: this.priceTrends.map(item => item.date),
            labels: { style: { colors: '#475569', fontSize: '10px', fontWeight: 700 } },
            axisBorder: { show: false },
            axisTicks: { show: false }
          },
          yaxis: {
            labels: { 
              style: { colors: '#475569', fontSize: '10px', fontWeight: 700 },
              formatter: (val) => val ? (val/1000000).toFixed(1) + 'M' : ''
            }
          },
          theme: { mode: 'dark' },
          tooltip: {
            theme: 'dark',
            x: { show: true },
            y: { formatter: (val) => val.toLocaleString() + ' ₺' }
          }
        };

        if (this.charts.price) this.charts.price.destroy();
        this.charts.price = new ApexCharts(document.querySelector("#priceTrendsChart"), options);
        this.charts.price.render();
      },

      renderNeighborhoodTreemap() {
        const options = {
          series: [{
            data: this.neighborhoods.slice(0, 15).map(item => ({
              x: item.neighborhood,
              y: item.count
            }))
          }],
          legend: { show: false },
          chart: {
            height: 320,
            type: 'treemap',
            toolbar: { show: false },
            background: 'transparent'
          },
          colors: ['#334155'],
          plotOptions: {
            treemap: {
              distributed: true,
              enableShades: false
            }
          },
          theme: { mode: 'dark' },
          dataLabels: {
            enabled: true,
            style: { fontSize: '10px', fontWeight: 'bold' },
            offsetY: -4
          }
        };

        if (this.charts.treemap) this.charts.treemap.destroy();
        this.charts.treemap = new ApexCharts(document.querySelector("#neighborhoodTreemap"), options);
        this.charts.treemap.render();
      },

      renderCategoryHeatmap() {
        const cats = Object.keys(this.stats.categories || {});
        const series = [
          {
            name: 'Satılık',
            data: cats.map(c => ({ x: c.toUpperCase(), y: this.stats.categories[c].satilik }))
          },
          {
            name: 'Kiralık',
            data: cats.map(c => ({ x: c.toUpperCase(), y: this.stats.categories[c].kiralik }))
          }
        ];

        const options = {
          series: series,
          chart: {
            height: 250,
            type: 'heatmap',
            toolbar: { show: false },
            background: 'transparent'
          },
          dataLabels: { enabled: true, style: { fontSize: '10px', colors: ['#000'] } },
          colors: ['#d9ff00'],
          theme: { mode: 'dark' },
          plotOptions: {
            heatmap: {
              shadeIntensity: 0.5,
              radius: 0,
              useFillColorAsStroke: true,
              colorScale: {
                ranges: [
                  { from: 0, to: 100, color: '#1a1a1a', name: 'Düşük' },
                  { from: 101, to: 500, color: '#334155', name: 'Orta' },
                  { from: 501, to: 10000, color: '#d9ff00', name: 'Yüksek' }
                ]
              }
            }
          },
          grid: { show: false }
        };

        if (this.charts.heatmap) this.charts.heatmap.destroy();
        this.charts.heatmap = new ApexCharts(document.querySelector("#categoryHeatmap"), options);
        this.charts.heatmap.render();
      }
    };
  }
</script>
{% endblock %}

